{{ template "base" . }}

{{ define "title" }}Decklist{{ end }}
{{ define "content" }}
  <div>
    <h3 class="mb-4 text-2xl font-bold text-gray-900 dark:text-white">
      {{ .Decklist.EventName }}
    </h3>
    <h4 class="mb-6 text-xl font-bold text-gray-900 dark:text-white">
      {{ .Decklist.DeckName }} <span class="text-sm text-gray-500 dark:text-gray-400">by {{ .Decklist.PlayerName }}</span>
    </h4>
  </div>
  <div class="grid grid-cols-1 gap-6 md:grid-cols-2">
    {{ $deckParts := slice
      (slice "Main Deck" .Decklist.MainDeck .Decklist.MainDeckCount "true")
      (slice "Sideboard" .Decklist.Sideboard .Decklist.SideboardCount "false")
    }}
    {{ range $deckParts }}
      {{ $title := index . 0 }}
      {{ $cards := index . 1 }}
      {{ $count := index . 2 }}
      {{ $showTypes := index . 3 }}
      <div class="rounded-lg border border-gray-200 bg-white shadow dark:border-gray-700 dark:bg-gray-800">
        <div class="p-4">
          <h5 class="pb-3 text-lg font-bold text-gray-900 dark:text-white">{{ $title }} ({{ $count }})</h5>
          <table class="min-w-full">
            <tbody>
              {{ $type := "" }}
              {{ range $cards }}
                {{ if and (eq $showTypes "true") (ne .CardType $type) }}
                  <tr>
                    <td colspan="2" class="{{ if ne $type "" }}pt-4{{ end }} text-sm uppercase">{{ cardtype .CardType }}</td>
                  </tr>
                {{ end }}
                <tr>
                  <td>{{ .Count }}</td>
                  <td>
                    {{ if eq .Legality "banned" }}
                      <a href="#" class="text-red-500 hover:underline" onclick="showCardImage('{{ .URL }}')"> {{ .Name }} ( banned ) </a>
                    {{ else }}
                      <a href="#" class="text-blue-500 hover:underline" onclick="showCardImage('{{ .URL }}')">
                        {{ .Name }}
                      </a>
                    {{ end }}
                  </td>
                </tr>
                {{ $type = .CardType }}
              {{ end }}
            </tbody>
          </table>
        </div>
      </div>
    {{ end }}
  </div>

  <div class="mt-8 flex justify-center">
    <button class="{{ .Scheme.ButtonBack }}" onclick="history.back()">Go Back</button>
  </div>

  <!-- Modal for card image -->
  <div id="cardImageModal" class="fixed inset-0 flex hidden items-center justify-center bg-black/80">
    <div class="flex flex-col justify-center rounded bg-white p-4 dark:bg-gray-800">
      <img id="cardImage" src="" alt="Card Image" class="h-auto max-w-80" />
      <button class="mt-4 rounded bg-red-500 px-4 py-2 text-white" onclick="closeCardImage()">Close</button>
    </div>
  </div>
{{ end }}

{{ define "post-script" }}
  <script>
    function showCardImage(url) {
      const modal = document.getElementById('cardImageModal');
      const image = document.getElementById('cardImage');
      image.src = url;
      modal.classList.remove('hidden');
    }

    function closeCardImage() {
      const modal = document.getElementById('cardImageModal');
      modal.classList.add('hidden');
    }

    document.addEventListener('click', (event) => {
      const modal = document.getElementById('cardImageModal');
      const modalContent = modal.querySelector('div');
      const isCardLink = event.target.closest('a') && event.target.closest('a').onclick;
      if (!isCardLink && !modalContent.contains(event.target) && !modal.classList.contains('hidden')) {
        closeCardImage();
      }
    });

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape') {
        closeCardImage();
      }
    });
  </script>
{{ end }}
